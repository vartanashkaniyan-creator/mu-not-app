/**
 * ðŸŒ Ø³ÛŒØ³ØªÙ… Ø¯ÙˆØ²Ø¨Ø§Ù†Ù‡ (ÙØ§Ø±Ø³ÛŒ/Ø§Ù†Ú¯Ù„ÛŒØ³ÛŒ)
 */

const Translations = {
    // ============ Ø¯ÛŒÚ©Ø´Ù†Ø±ÛŒ ØªØ±Ø¬Ù…Ù‡ ============
    dictionary: {
        en: {
            // Ø¹Ù…ÙˆÙ…ÛŒ
            'app_name': 'Mobile App Builder',
            'status': 'Status',
            'ready': 'Ready',
            'loading': 'Loading...',
            'error': 'Error',
            'success': 'Success',
            'save': 'Save',
            'cancel': 'Cancel',
            'delete': 'Delete',
            'edit': 'Edit',
            'search': 'Search',
            'home': 'Home',
            'back': 'Back',
            'next': 'Next',
            'settings': 'Settings',
            'language': 'Language',
            
            // Ø¯Ø³ØªÙˆØ±Ø§Øª
            'enter_command': 'Enter command...',
            'execute': 'Execute',
            'example': 'Example',
            'page_note': 'page note',
            'page_calculator': 'page calculator',
            'page_todo': 'page todo',
            
            // ØµÙØ­Ø§Øª
            'welcome': 'Welcome!',
            'welcome_message': 'Enter a command or select from options:',
            'quick_actions': 'Quick Actions',
            'notes': 'Notes',
            'calculator': 'Calculator',
            'todo_list': 'Todo List',
            'timer': 'Timer',
            'calendar': 'Calendar',
            'converter': 'Unit Converter',
            'contacts': 'Contacts',
            'weather': 'Weather',
            'map': 'Map',
            'translator': 'Translator',
            'finance': 'Finance',
            'health': 'Health',
            
            // Ø¯Ú©Ù…Ù‡â€ŒÙ‡Ø§
            'save_note': 'Save Note',
            'load_note': 'Load Note',
            'clear_note': 'Clear',
            'add_item': 'Add Item',
            'clear_all': 'Clear All',
            'start': 'Start',
            'pause': 'Pause',
            'reset': 'Reset',
            
            // Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§
            'saved_successfully': 'Saved successfully',
            'deleted_successfully': 'Deleted successfully',
            'are_you_sure': 'Are you sure?',
            'no_data': 'No data available',
            'coming_soon': 'Coming soon...',
            
            // Ø§Ø±ÙˆØ±Ù‡Ø§
            'invalid_command': 'Invalid command',
            'command_not_found': 'Command not found',
            'try_again': 'Please try again',
            
            // Ø¢Ù…Ø§Ø±
            'total': 'Total',
            'completed': 'Completed',
            'remaining': 'Remaining',
            'characters': 'Characters',
            'words': 'Words'
        },
        
        fa: {
            // Ø¹Ù…ÙˆÙ…ÛŒ
            'app_name': 'Ø³Ø§Ø²Ù†Ø¯Ù‡ Ø§Ù¾ Ù…ÙˆØ¨Ø§ÛŒÙ„',
            'status': 'ÙˆØ¶Ø¹ÛŒØª',
            'ready': 'Ø¢Ù…Ø§Ø¯Ù‡',
            'loading': 'Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ...',
            'error': 'Ø®Ø·Ø§',
            'success': 'Ù…ÙˆÙÙ‚',
            'save': 'Ø°Ø®ÛŒØ±Ù‡',
            'cancel': 'Ù„ØºÙˆ',
            'delete': 'Ø­Ø°Ù',
            'edit': 'ÙˆÛŒØ±Ø§ÛŒØ´',
            'search': 'Ø¬Ø³ØªØ¬Ùˆ',
            'home': 'Ø®Ø§Ù†Ù‡',
            'back': 'Ø¨Ø§Ø²Ú¯Ø´Øª',
            'next': 'Ø¨Ø¹Ø¯ÛŒ',
            'settings': 'ØªÙ†Ø¸ÛŒÙ…Ø§Øª',
            'language': 'Ø²Ø¨Ø§Ù†',
            
            // Ø¯Ø³ØªÙˆØ±Ø§Øª
            'enter_command': 'Ø¯Ø³ØªÙˆØ± Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯...',
            'execute': 'Ø§Ø¬Ø±Ø§',
            'example': 'Ù…Ø«Ø§Ù„',
            'page_note': 'ØµÙØ­Ù‡ ÛŒØ§Ø¯Ø¯Ø§Ø´Øª',
            'page_calculator': 'ØµÙØ­Ù‡ Ù…Ø§Ø´ÛŒÙ† Ø­Ø³Ø§Ø¨',
            'page_todo': 'ØµÙØ­Ù‡ Ú©Ø§Ø±Ù‡Ø§',
            
            // ØµÙØ­Ø§Øª
            'welcome': 'Ø®ÙˆØ´ Ø¢Ù…Ø¯ÛŒØ¯!',
            'welcome_message': 'Ø¯Ø³ØªÙˆØ± ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯ ÛŒØ§ Ø§Ø² Ú¯Ø²ÛŒÙ†Ù‡â€ŒÙ‡Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ù†Ù…Ø§ÛŒÛŒØ¯:',
            'quick_actions': 'Ø¯Ø³ØªÙˆØ±Ø§Øª Ø³Ø±ÛŒØ¹',
            'notes': 'ÛŒØ§Ø¯Ø¯Ø§Ø´Øª',
            'calculator': 'Ù…Ø§Ø´ÛŒÙ† Ø­Ø³Ø§Ø¨',
            'todo_list': 'Ù„ÛŒØ³Øª Ú©Ø§Ø±Ù‡Ø§',
            'timer': 'ØªØ§ÛŒÙ…Ø±',
            'calendar': 'ØªÙ‚ÙˆÛŒÙ…',
            'converter': 'Ù…Ø¨Ø¯Ù„ ÙˆØ§Ø­Ø¯',
            'contacts': 'Ù…Ø®Ø§Ø·Ø¨ÛŒÙ†',
            'weather': 'Ø¢Ø¨ Ùˆ Ù‡ÙˆØ§',
            'map': 'Ù†Ù‚Ø´Ù‡',
            'translator': 'Ù…ØªØ±Ø¬Ù…',
            'finance': 'Ù…Ø§Ù„ÛŒ',
            'health': 'Ø³Ù„Ø§Ù…ØªÛŒ',
            
            // Ø¯Ú©Ù…Ù‡â€ŒÙ‡Ø§
            'save_note': 'Ø°Ø®ÛŒØ±Ù‡ ÛŒØ§Ø¯Ø¯Ø§Ø´Øª',
            'load_note': 'Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ ÛŒØ§Ø¯Ø¯Ø§Ø´Øª',
            'clear_note': 'Ù¾Ø§Ú© Ú©Ø±Ø¯Ù†',
            'add_item': 'Ø§ÙØ²ÙˆØ¯Ù† Ø¢ÛŒØªÙ…',
            'clear_all': 'Ø­Ø°Ù Ù‡Ù…Ù‡',
            'start': 'Ø´Ø±ÙˆØ¹',
            'pause': 'ØªÙˆÙ‚Ù',
            'reset': 'Ø¨Ø§Ø²Ù†Ø´Ø§Ù†ÛŒ',
            
            // Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§
            'saved_successfully': 'Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯',
            'deleted_successfully': 'Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø­Ø°Ù Ø´Ø¯',
            'are_you_sure': 'Ø¢ÛŒØ§ Ù…Ø·Ù…Ø¦Ù† Ù‡Ø³ØªÛŒØ¯ØŸ',
            'no_data': 'Ø¯Ø§Ø¯Ù‡â€ŒØ§ÛŒ Ù…ÙˆØ¬ÙˆØ¯ Ù†ÛŒØ³Øª',
            'coming_soon': 'Ø¨Ù‡ Ø²ÙˆØ¯ÛŒ...',
            
            // Ø§Ø±ÙˆØ±Ù‡Ø§
            'invalid_command': 'Ø¯Ø³ØªÙˆØ± Ù†Ø§Ù…Ø¹ØªØ¨Ø±',
            'command_not_found': 'Ø¯Ø³ØªÙˆØ± ÛŒØ§ÙØª Ù†Ø´Ø¯',
            'try_again': 'Ù„Ø·ÙØ§Ù‹ Ø¯ÙˆØ¨Ø§Ø±Ù‡ Ø§Ù…ØªØ­Ø§Ù† Ú©Ù†ÛŒØ¯',
            
            // Ø¢Ù…Ø§Ø±
            'total': 'Ú©Ù„',
            'completed': 'Ø§Ù†Ø¬Ø§Ù… Ø´Ø¯Ù‡',
            'remaining': 'Ø¨Ø§Ù‚ÛŒâ€ŒÙ…Ø§Ù†Ø¯Ù‡',
            'characters': 'Ú©Ø§Ø±Ø§Ú©ØªØ±',
            'words': 'Ú©Ù„Ù…Ù‡'
        }
    },
    
    // ============ ÙˆØ¶Ø¹ÛŒØª ÙØ¹Ù„ÛŒ ============
    currentLang: 'fa',
    
    // ============ ØªÙˆØ§Ø¨Ø¹ Ø§ØµÙ„ÛŒ ============
    
    // ØªØºÛŒÛŒØ± Ø²Ø¨Ø§Ù†
    setLanguage(lang) {
        if (this.dictionary[lang]) {
            this.currentLang = lang;
            localStorage.setItem('app_language', lang);
            
            // Ø§Ø¹Ù…Ø§Ù„ ØªØºÛŒÛŒØ±Ø§Øª
            this.applyTranslations();
            this.updateDirection();
            
            // Ø°Ø®ÛŒØ±Ù‡ Ø¯Ø± AppState Ø§Ú¯Ø± Ù…ÙˆØ¬ÙˆØ¯ Ø§Ø³Øª
            if (window.AppState) {
                AppState.data.language = lang;
                AppState.save();
            }
            
            console.log(`ðŸŒ Ø²Ø¨Ø§Ù† ØªØºÛŒÛŒØ± Ú©Ø±Ø¯ Ø¨Ù‡: ${lang}`);
            return true;
        }
        return false;
    },
    
    // Ø¯Ø±ÛŒØ§ÙØª ØªØ±Ø¬Ù…Ù‡
    t(key, params = {}) {
        let translation = this.dictionary[this.currentLang][key] || 
                         this.dictionary.en[key] || 
                         key;
        
        // Ø¬Ø§ÛŒÚ¯Ø²ÛŒÙ†ÛŒ Ù¾Ø§Ø±Ø§Ù…ØªØ±Ù‡Ø§
        Object.keys(params).forEach(param => {
            translation = translation.replace(`{{${param}}}`, params[param]);
        });
        
        return translation;
    },
    
    // ØªØ±Ø¬Ù…Ù‡ Ù…ØªÙˆÙ† Ø¯Ø± ØµÙØ­Ù‡
    applyTranslations() {
        // Ø¹Ù†Ø§ØµØ±ÛŒ Ú©Ù‡ data-i18n Ø¯Ø§Ø±Ù†Ø¯
        document.querySelectorAll('[data-i18n]').forEach(element => {
            const key = element.getAttribute('data-i18n');
            const translation = this.t(key);
            
            if (element.tagName === 'INPUT' || element.tagName === 'TEXTAREA') {
                element.placeholder = translation;
            } else {
                element.textContent = translation;
            }
        });
        
        // Ø¹Ù†Ø§ØµØ±ÛŒ Ú©Ù‡ data-i18n-title Ø¯Ø§Ø±Ù†Ø¯
        document.querySelectorAll('[data-i18n-title]').forEach(element => {
            const key = element.getAttribute('data-i18n-title');
            element.title = this.t(key);
        });
        
        // Ø¹Ù†Ø§ØµØ±ÛŒ Ú©Ù‡ data-i18n-aria-label Ø¯Ø§Ø±Ù†Ø¯
        document.querySelectorAll('[data-i18n-aria-label]').forEach(element => {
            const key = element.getAttribute('data-i18n-aria-label');
            element.setAttribute('aria-label', this.t(key));
        });
        
        // Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ø¹Ù†ÙˆØ§Ù† ØµÙØ­Ù‡
        const title = document.querySelector('title');
        if (title && !title.hasAttribute('data-i18n')) {
            title.textContent = this.t('app_name');
        }
        
        // Ø§Ø¹Ù…Ø§Ù„ Ø±ÙˆÛŒ Ø§Ø¬Ø²Ø§ÛŒ Ø¯Ø§ÛŒÙ†Ø§Ù…ÛŒÚ©
        this.updateDynamicContent();
    },
    
    // Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ø§Ø¬Ø²Ø§ÛŒ Ø¯Ø§ÛŒÙ†Ø§Ù…ÛŒÚ©
    updateDynamicContent() {
        // Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ø¯Ú©Ù…Ù‡â€ŒÙ‡Ø§ Ùˆ Ù…ØªÙ†â€ŒÙ‡Ø§ÛŒ Ø§ÛŒØ¬Ø§Ø¯ Ø´Ø¯Ù‡ ØªÙˆØ³Ø· Ø¬Ø§ÙˆØ§Ø§Ø³Ú©Ø±ÛŒÙ¾Øª
        const appTitle = document.querySelector('.app-title');
        if (appTitle && window.AppState?.current?.schema?.title) {
            // Ø§Ú¯Ø± Ø¹Ù†ÙˆØ§Ù† Ø§Ø² Ù…ÙˆØªÙˆØ± Ø¢Ù…Ø¯Ù‡ØŒ ØªØ±Ø¬Ù…Ù‡ Ú©Ù†
            const currentTitle = AppState.current.schema.title;
            const translatedTitle = this.translateText(currentTitle);
            appTitle.textContent = translatedTitle;
        }
        
        // Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ ÙˆØ¶Ø¹ÛŒØª
        const statusEl = document.getElementById('app-status');
        if (statusEl) {
            const currentText = statusEl.textContent;
            const translatedStatus = this.translateText(currentText);
            if (translatedStatus !== currentText) {
                statusEl.textContent = translatedStatus;
            }
        }
    },
    
    // ØªØ±Ø¬Ù…Ù‡ Ù…ØªÙ† Ù…Ø¹Ù…ÙˆÙ„ÛŒ (ØºÛŒØ± Ú©Ù„ÛŒØ¯)
    translateText(text) {
        if (!text || typeof text !== 'string') return text;
        
        // Ø¬Ø³ØªØ¬ÙˆÛŒ Ù…Ø¹Ø§Ø¯Ù„ Ø¯Ø± Ø¯ÛŒÚ©Ø´Ù†Ø±ÛŒ
        const entries = Object.entries(this.dictionary[this.currentLang]);
        for (const [key, value] of entries) {
            if (text.includes(key) || text.toLowerCase().includes(key.toLowerCase())) {
                // Ø§Ú¯Ø± Ù…ØªÙ† Ø¯Ù‚ÛŒÙ‚Ø§Ù‹ Ø¨Ø§ Ú©Ù„ÛŒØ¯ Ù…Ø·Ø§Ø¨Ù‚Øª Ø¯Ø§Ø±Ø¯
                if (text.trim() === key || text.trim().toLowerCase() === key.toLowerCase()) {
                    return value;
                }
            }
        }
        
        return text;
    },
    
    // ØªÙ†Ø¸ÛŒÙ… Ø¬Ù‡Øª Ù…ØªÙ†
    updateDirection() {
        document.documentElement.dir = this.currentLang === 'fa' ? 'rtl' : 'ltr';
        document.documentElement.lang = this.currentLang;
        
        // Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† Ú©Ù„Ø§Ø³ Ø¬Ù‡Øª
        document.body.classList.remove('ltr', 'rtl');
        document.body.classList.add(this.currentLang === 'fa' ? 'rtl' : 'ltr');
    },
    
    // Ù…Ù‚Ø¯Ø§Ø±Ø¯Ù‡ÛŒ Ø§ÙˆÙ„ÛŒÙ‡
    init() {
        // Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø²Ø¨Ø§Ù† Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯Ù‡
        const savedLang = localStorage.getItem('app_language') || 'fa';
        this.setLanguage(savedLang);
        
        // Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† Ú©Ù„Ø§Ø³ Ø¬Ù‡Øª
        this.updateDirection();
        
        // Ø±Ø¯ÛŒØ§Ø¨ÛŒ ØªØºÛŒÛŒØ±Ø§Øª DOM Ø¨Ø±Ø§ÛŒ Ø¹Ù†Ø§ØµØ± Ø¬Ø¯ÛŒØ¯
        const observer = new MutationObserver(() => {
            this.applyTranslations();
        });
        
        observer.observe(document.body, {
            childList: true,
            subtree: true
        });
        
        console.log('ðŸŒ Ø³ÛŒØ³ØªÙ… ØªØ±Ø¬Ù…Ù‡ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø´Ø¯');
    },
    
    // ============ Ø§Ø¨Ø²Ø§Ø±Ù‡Ø§ÛŒ Ú©Ù…Ú©ÛŒ ============
    
    // ØªØ´Ø®ÛŒØµ Ø²Ø¨Ø§Ù† Ù…Ø±ÙˆØ±Ú¯Ø±
    detectBrowserLanguage() {
        const browserLang = (navigator.language || navigator.userLanguage || 'en').substring(0, 2);
        return browserLang === 'fa' ? 'fa' : 'en';
    },
    
    // Ù„ÛŒØ³Øª Ø²Ø¨Ø§Ù†â€ŒÙ‡Ø§ÛŒ Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ Ø´Ø¯Ù‡
    getSupportedLanguages() {
        return Object.keys(this.dictionary).map(lang => ({
            code: lang,
            name: lang === 'fa' ? 'ÙØ§Ø±Ø³ÛŒ' : 'English',
            native: lang === 'fa' ? 'ÙØ§Ø±Ø³ÛŒ' : 'English',
            dir: lang === 'fa' ? 'rtl' : 'ltr'
        }));
    },
    
    // ØªØºÛŒÛŒØ± Ø®ÙˆØ¯Ú©Ø§Ø± Ø²Ø¨Ø§Ù†
    toggleLanguage() {
        const newLang = this.currentLang === 'fa' ? 'en' : 'fa';
        return this.setLanguage(newLang);
    },
    
    // ØªØ±Ø¬Ù…Ù‡ Ø¯Ø³ØªÙˆØ±Ø§Øª
    translateCommand(command) {
        if (this.currentLang === 'fa') {
            // Ø§Ú¯Ø± Ú©Ø§Ø±Ø¨Ø± ÙØ§Ø±Ø³ÛŒ ØªØ§ÛŒÙ¾ Ú©Ø±Ø¯ØŒ Ø¨Ù‡ Ø§Ù†Ú¯Ù„ÛŒØ³ÛŒ ØªØ¨Ø¯ÛŒÙ„ Ú©Ù†
            const faToEn = {
                'ØµÙØ­Ù‡': 'screen',
                'ÛŒØ§Ø¯Ø¯Ø§Ø´Øª': 'note',
                'Ù…Ø§Ø´ÛŒÙ† Ø­Ø³Ø§Ø¨': 'calculator',
                'Ú©Ø§Ø±Ù‡Ø§': 'todo',
                'ØªØ§ÛŒÙ…Ø±': 'timer',
                'ØªÙ‚ÙˆÛŒÙ…': 'calendar',
                'Ø¹Ù†ÙˆØ§Ù†': 'title',
                'Ù‡Ø´Ø¯Ø§Ø±': 'alert'
            };
            
            let translated = command;
            Object.entries(faToEn).forEach(([fa, en]) => {
                translated = translated.replace(new RegExp(fa, 'g'), en);
            });
            return translated;
        }
        return command;
    },
    
    // Ù‚Ø§Ù„Ø¨ Ù¾ÛŒØ§Ù…
    formatMessage(key, params = {}) {
        return this.t(key, params);
    }
};

// ============ API Ø¹Ù…ÙˆÙ…ÛŒ ============

// ØªØ§Ø¨Ø¹ ØªØ±Ø¬Ù…Ù‡ Ø³Ø±ÛŒØ¹
function t(key, params) {
    return Translations.t(key, params);
}

// ØªØºÛŒÛŒØ± Ø²Ø¨Ø§Ù†
function setLanguage(lang) {
    return Translations.setLanguage(lang);
}

// Ø¯Ø±ÛŒØ§ÙØª Ø²Ø¨Ø§Ù† ÙØ¹Ù„ÛŒ
function getCurrentLanguage() {
    return Translations.currentLang;
}

// ØªØºÛŒÛŒØ± Ø®ÙˆØ¯Ú©Ø§Ø± Ø²Ø¨Ø§Ù†
function toggleLanguage() {
    return Translations.toggleLanguage();
}

// ============ ØµØ§Ø¯Ø± Ú©Ø±Ø¯Ù† ============
window.i18n = Translations;
window.t = t;
window.setLanguage = setLanguage;
window.getCurrentLanguage = getCurrentLanguage;
window.toggleLanguage = toggleLanguage;

// Ø´Ø±ÙˆØ¹ Ø®ÙˆØ¯Ú©Ø§Ø±
document.addEventListener('DOMContentLoaded', () => {
    Translations.init();
});
